MANUAL DEPLOYMENT COMMANDS FOR ARC AND COBALT

=== FOR ARC (192.168.68.146) ===
ssh root@192.168.68.146

# Create installer script on Arc
cat > /tmp/install_shared.sh << 'EOF'
#!/bin/bash
set -e
echo "Installing Zabbix Agent for Arc..."

# Get Ubuntu version and set Zabbix version
OS_VERSION=$(lsb_release -rs)
case "$OS_VERSION" in
    24.04) ZABBIX_VERSION="7.0"; REPO_VERSION="22.04" ;;
    22.04) ZABBIX_VERSION="6.4"; REPO_VERSION="22.04" ;;
    20.04) ZABBIX_VERSION="6.0"; REPO_VERSION="20.04" ;;
    *) ZABBIX_VERSION="6.0"; REPO_VERSION="$OS_VERSION" ;;
esac

# Install Zabbix repository
wget -q -O /tmp/zabbix-release.deb "https://repo.zabbix.com/zabbix/${ZABBIX_VERSION}/ubuntu/pool/main/z/zabbix-release/zabbix-release_${ZABBIX_VERSION}-4+ubuntu${REPO_VERSION}_all.deb"
dpkg -i /tmp/zabbix-release.deb
apt-get update -q

# Install packages
apt-get install -qq -y zabbix-agent2 lm-sensors smartmontools || apt-get install -qq -y zabbix-agent lm-sensors smartmontools

# Detect which agent was installed
if systemctl list-unit-files | grep -q zabbix-agent2; then
    AGENT_CONFIG="/etc/zabbix/zabbix_agent2.conf"
    AGENT_SERVICE="zabbix-agent2"
    CUSTOM_DIR="/etc/zabbix/zabbix_agent2.d"
else
    AGENT_CONFIG="/etc/zabbix/zabbix_agentd.conf"
    AGENT_SERVICE="zabbix-agent"
    CUSTOM_DIR="/etc/zabbix/zabbix_agentd.d"
fi

# Configure main agent file
cat > "$AGENT_CONFIG" << AGENTEOF
Server=192.168.70.2
ServerActive=192.168.70.2:10051
Hostname=Arc
LogFile=/var/log/zabbix/\$(basename \$AGENT_CONFIG .conf).log
Include=\$CUSTOM_DIR/*.conf
AGENTEOF

# Create custom parameters directory and file
mkdir -p "$CUSTOM_DIR"
cat > "$CUSTOM_DIR/ubuntu_shared.conf" << 'CUSTOMEOF'
# Shared Ubuntu Template Parameters
UserParameter=ubuntu.cpu.temp,sensors 2>/dev/null | grep -E 'Core|Package' | grep -oE '[0-9]+\.[0-9]+' | head -1
UserParameter=ubuntu.mem.available,free -b | awk '/^Mem:/{print $7}'
UserParameter=ubuntu.disk.count,lsblk -d -o TYPE | grep -c disk
UserParameter=ubuntu.service.status[*],systemctl is-active $1 2>/dev/null || echo "inactive"
UserParameter=ubuntu.docker.containers,docker ps -q 2>/dev/null | wc -l || echo 0
UserParameter=ubuntu.updates.available,apt list --upgradable 2>/dev/null | grep -c upgradable || echo 0
UserParameter=ubuntu.updates.security,apt list --upgradable 2>/dev/null | grep -c security || echo 0
UserParameter=ubuntu.net.established,ss -tan | grep ESTABLISHED | wc -l
UserParameter=ubuntu.net.listening,ss -tln | grep LISTEN | wc -l
UserParameter=ubuntu.disk.temp[*],smartctl -A /dev/$1 2>/dev/null | grep Temperature_Celsius | awk '{print $10}' || echo 0
UserParameter=ubuntu.disk.smart[*],smartctl -H /dev/$1 2>/dev/null | grep -q "PASSED" && echo 1 || echo 0
UserParameter=ubuntu.reboot.required,test -f /var/run/reboot-required && echo 1 || echo 0
UserParameter=ubuntu.uptime.days,uptime | awk '{print $3}' | sed 's/,//'
UserParameter=ubuntu.kernel.version,uname -r
CUSTOMEOF

# Set permissions
chown zabbix:zabbix "$AGENT_CONFIG" "$CUSTOM_DIR/ubuntu_shared.conf" 2>/dev/null || true
chmod 640 "$AGENT_CONFIG" "$CUSTOM_DIR/ubuntu_shared.conf" 2>/dev/null || true

# Configure sudo for monitoring
cat > /etc/sudoers.d/zabbix << SUDOEOF
zabbix ALL=(ALL) NOPASSWD: /usr/bin/systemctl, /usr/sbin/smartctl, /usr/bin/docker, /usr/bin/sensors, /usr/bin/apt
Defaults:zabbix !requiretty
SUDOEOF
chmod 440 /etc/sudoers.d/zabbix

# Configure sensors
yes | sensors-detect >/dev/null 2>&1 || true

# Restart and enable agent
systemctl restart "$AGENT_SERVICE"
systemctl enable "$AGENT_SERVICE"

echo "Arc Zabbix agent installation completed!"
echo "Agent service: $AGENT_SERVICE"
echo "Config file: $AGENT_CONFIG"

# Test agent
sleep 2
if systemctl is-active --quiet "$AGENT_SERVICE"; then
    echo "✓ Agent is running"
    zabbix_get -s localhost -k agent.ping 2>/dev/null && echo "✓ Agent responds to ping"
    zabbix_get -s localhost -k ubuntu.cpu.temp 2>/dev/null && echo "✓ Custom metrics working"
else
    echo "✗ Agent may have issues"
    journalctl -u "$AGENT_SERVICE" -n 10 --no-pager
fi
EOF

# Run the installer
chmod +x /tmp/install_shared.sh
sudo /tmp/install_shared.sh

=== FOR COBALT (192.168.70.35) ===
ssh root@192.168.70.35

# Create the same installer but with hostname=Cobalt
cat > /tmp/install_shared.sh << 'EOF'
#!/bin/bash
set -e
echo "Installing Zabbix Agent for Cobalt..."

# Get Ubuntu version and set Zabbix version
OS_VERSION=$(lsb_release -rs)
case "$OS_VERSION" in
    24.04) ZABBIX_VERSION="7.0"; REPO_VERSION="22.04" ;;
    22.04) ZABBIX_VERSION="6.4"; REPO_VERSION="22.04" ;;
    20.04) ZABBIX_VERSION="6.0"; REPO_VERSION="20.04" ;;
    *) ZABBIX_VERSION="6.0"; REPO_VERSION="$OS_VERSION" ;;
esac

# Install Zabbix repository
wget -q -O /tmp/zabbix-release.deb "https://repo.zabbix.com/zabbix/${ZABBIX_VERSION}/ubuntu/pool/main/z/zabbix-release/zabbix-release_${ZABBIX_VERSION}-4+ubuntu${REPO_VERSION}_all.deb"
dpkg -i /tmp/zabbix-release.deb
apt-get update -q

# Install packages
apt-get install -qq -y zabbix-agent2 lm-sensors smartmontools || apt-get install -qq -y zabbix-agent lm-sensors smartmontools

# Detect which agent was installed
if systemctl list-unit-files | grep -q zabbix-agent2; then
    AGENT_CONFIG="/etc/zabbix/zabbix_agent2.conf"
    AGENT_SERVICE="zabbix-agent2"
    CUSTOM_DIR="/etc/zabbix/zabbix_agent2.d"
else
    AGENT_CONFIG="/etc/zabbix/zabbix_agentd.conf"
    AGENT_SERVICE="zabbix-agent"
    CUSTOM_DIR="/etc/zabbix/zabbix_agentd.d"
fi

# Configure main agent file
cat > "$AGENT_CONFIG" << AGENTEOF
Server=192.168.70.2
ServerActive=192.168.70.2:10051
Hostname=Cobalt
LogFile=/var/log/zabbix/\$(basename \$AGENT_CONFIG .conf).log
Include=\$CUSTOM_DIR/*.conf
AGENTEOF

# Create custom parameters directory and file
mkdir -p "$CUSTOM_DIR"
cat > "$CUSTOM_DIR/ubuntu_shared.conf" << 'CUSTOMEOF'
# Shared Ubuntu Template Parameters
UserParameter=ubuntu.cpu.temp,sensors 2>/dev/null | grep -E 'Core|Package' | grep -oE '[0-9]+\.[0-9]+' | head -1
UserParameter=ubuntu.mem.available,free -b | awk '/^Mem:/{print $7}'
UserParameter=ubuntu.disk.count,lsblk -d -o TYPE | grep -c disk
UserParameter=ubuntu.service.status[*],systemctl is-active $1 2>/dev/null || echo "inactive"
UserParameter=ubuntu.docker.containers,docker ps -q 2>/dev/null | wc -l || echo 0
UserParameter=ubuntu.updates.available,apt list --upgradable 2>/dev/null | grep -c upgradable || echo 0
UserParameter=ubuntu.updates.security,apt list --upgradable 2>/dev/null | grep -c security || echo 0
UserParameter=ubuntu.net.established,ss -tan | grep ESTABLISHED | wc -l
UserParameter=ubuntu.net.listening,ss -tln | grep LISTEN | wc -l
UserParameter=ubuntu.disk.temp[*],smartctl -A /dev/$1 2>/dev/null | grep Temperature_Celsius | awk '{print $10}' || echo 0
UserParameter=ubuntu.disk.smart[*],smartctl -H /dev/$1 2>/dev/null | grep -q "PASSED" && echo 1 || echo 0
UserParameter=ubuntu.reboot.required,test -f /var/run/reboot-required && echo 1 || echo 0
UserParameter=ubuntu.uptime.days,uptime | awk '{print $3}' | sed 's/,//'
UserParameter=ubuntu.kernel.version,uname -r
CUSTOMEOF

# Set permissions
chown zabbix:zabbix "$AGENT_CONFIG" "$CUSTOM_DIR/ubuntu_shared.conf" 2>/dev/null || true
chmod 640 "$AGENT_CONFIG" "$CUSTOM_DIR/ubuntu_shared.conf" 2>/dev/null || true

# Configure sudo for monitoring
cat > /etc/sudoers.d/zabbix << SUDOEOF
zabbix ALL=(ALL) NOPASSWD: /usr/bin/systemctl, /usr/sbin/smartctl, /usr/bin/docker, /usr/bin/sensors, /usr/bin/apt
Defaults:zabbix !requiretty
SUDOEOF
chmod 440 /etc/sudoers.d/zabbix

# Configure sensors
yes | sensors-detect >/dev/null 2>&1 || true

# Restart and enable agent
systemctl restart "$AGENT_SERVICE"
systemctl enable "$AGENT_SERVICE"

echo "Cobalt Zabbix agent installation completed!"
echo "Agent service: $AGENT_SERVICE"
echo "Config file: $AGENT_CONFIG"

# Test agent
sleep 2
if systemctl is-active --quiet "$AGENT_SERVICE"; then
    echo "✓ Agent is running"
    zabbix_get -s localhost -k agent.ping 2>/dev/null && echo "✓ Agent responds to ping"
    zabbix_get -s localhost -k ubuntu.cpu.temp 2>/dev/null && echo "✓ Custom metrics working"
else
    echo "✗ Agent may have issues"
    journalctl -u "$AGENT_SERVICE" -n 10 --no-pager
fi
EOF

# Run the installer
chmod +x /tmp/install_shared.sh
sudo /tmp/install_shared.sh

=== AFTER BOTH SERVERS ARE CONFIGURED ===

1. TEST FROM ZABBIX SERVER (192.168.70.2):
   zabbix_get -s 192.168.68.146 -k agent.ping
   zabbix_get -s 192.168.70.35 -k agent.ping
   zabbix_get -s 192.168.68.146 -k ubuntu.cpu.temp
   zabbix_get -s 192.168.70.35 -k ubuntu.mem.available

2. IMPORT TEMPLATE TO ZABBIX:
   - Copy Template_Ubuntu_Shared.json to your Zabbix server
   - Go to Configuration → Templates → Import
   - Select Template_Ubuntu_Shared.json
   - Click Import

3. ADD HOSTS IN ZABBIX:
   - Go to Configuration → Hosts → Create Host
   - Host 1: Name="Arc", IP="192.168.68.146", Template="Template Ubuntu Shared"
   - Host 2: Name="Cobalt", IP="192.168.70.35", Template="Template Ubuntu Shared"

4. VERIFY DATA COLLECTION:
   - Check Monitoring → Latest Data
   - Look for ubuntu.* items for both hosts